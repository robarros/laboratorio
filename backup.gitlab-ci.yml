---
stages:
  - scan
  - build
  - deployment

scan vulnerabilities:
  stage: scan
  image: snyk/snyk-cli:python-3
  script:
    - cd ./api_rest
    - snyk test
  only:
    refs:
      - main
      - develop
    changes:
      - api_rest/**/*
      - .gitlab-ci.yml

get last tag:
  stage: build
  script:
    - TAG=$(git describe --tags --abbrev=0)
    - echo $TAG > tag.txt
    - cat tag.txt
  artifacts:
    paths:
    - tag.txt
    expire_in: 30 mins
  only:
    refs:
      - main
      - develop
    changes:
      - api_rest/**/*
      - .gitlab-ci.yml

build and push to repositories:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  variables:
    REPO_NAME: robarros
    IMAGE_NAME: api_rest
  script:
    - TAG=$(cat tag.txt)
    - echo $TAG
    - cd ./api_rest
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context . --dockerfile ./Dockerfile --destination $REPO_NAME/$IMAGE_NAME:$TAG
  only:
    refs:
      - main
      - develop
    changes:
      - api_rest/**/*
      - .gitlab-ci.yml

deploy to development environment:
  stage: deployment
  image: alpine/k8s:1.21.2
  environment:
    name: development
    url: https://dev.164.90.252.29.nip.io
  variables:
    REPO_NAME: robarros
    IMAGE_NAME: api_rest
    DEPLOY_NAME: api_rest
  script:
    - TAG=$(cat tag.txt)
    - echo $TAG
    - mkdir /root/.kube
    - echo "${KUBECONFIG}" | base64 -d | tee > /root/.kube/config
    - cd ./api_rest/chart
    - sed -i "s|TAG|${TAG}|g" ./Chart.yaml
    - sed -i "s|TAG|${TAG}|g" ./values.yaml
    - sed -i "s|REPO_NAME|${REPO_NAME}/${IMAGE_NAME}|g" ./values.yaml
    - helm upgrade --install -n api_rest_dev $DEPLOY_NAME . -f values.yaml --create-namespace        
  only:
    refs:
      - develop
    changes:
      - api_rest/**/*
      - .gitlab-ci.yml

deploy to production environment:
  stage: deployment
  image: alpine/k8s:1.21.2
  environment:
    name: production
    url: "https://prod.164.90.252.29.nip.io"
  variables:
    REPO_NAME: robarros
    IMAGE_NAME: api_rest
    DEPLOY_NAME: api_rest
  script:
    - TAG=$(cat tag.txt)
    - echo $TAG
    - mkdir /root/.kube
    - echo "${KUBECONFIG}" | base64 -d | tee > /root/.kube/config
    - cd ./api_rest/chart
    - sed -i "s|TAG|${TAG}|g" ./Chart.yaml
    - sed -i "s|TAG|${TAG}|g" ./values.yaml
    - sed -i "s|REPO_NAME|${REPO_NAME}/${IMAGE_NAME}|g" ./values.yaml
    - helm upgrade --install -n api_rest_prod $DEPLOY_NAME . -f values.yaml --create-namespace    
  when: manual
  only:
    refs:
      - develop

